<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />

    <title>Document</title>

    <style>
      .terminal {
        font-family: Consolas;
        height: 50vw;
        max-height: 100%;
        max-width: 100%;
        width: 50vw;
      }
      .terminal-header {
        color: cyan;
      }
      .terminal-output {
        color: snow;
        font-size: 80%;
        overflow-y: scroll;
      }
    </style>
    <style>
      *::-webkit-scrollbar-track {
        background-color: transparent;
      }

      *::-webkit-scrollbar {
        width: 12px;
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 1rem;
      }

      *::-webkit-scrollbar-thumb {
        border-radius: 1rem;

        background-color: white;
      }
    </style>
  </head>
  <body class="w-100 h-100">
    <div class="d-flex align-items-center justify-content-center w-100 h-100">
      <div
        id="result"
        class="col-6 bg-dark text-white terminal d-flex flex-column rounded"
      >
        <span class="terminal-header">
          output&gt; Connected: <span id="cons"></span
        ></span>
        <div id="output" class="terminal-output flex-grow-1"></div>
      </div>
    </div>

    <script>
      //selectors
      const $ = document.querySelector.bind(document),
        $$ = document.querySelectorAll.bind(document);

      //elem
      const output = $("#output");

      //sse
      let evtSource = (window.evtSource = {});
      const join = (force, rejoined) => {
        force && evtSource.close();
        evtSource = new EventSource(`/events${rejoined ? "?rejoin" : ""}`);

        evtSource.addEventListener(
          "open",
          evt => {
            console.warn("✔️listening.");
          },
          false
        );

        evtSource.addEventListener(
          "message",
          evt => {
            const payload = JSON.parse(evt.data);
            switch (payload.packet) {
              case "msg":
                {
                  output.innerHTML += `${output.innerHTML ? "<br>" : ""} ${
                    new Date()
                      .toISOString()
                      .split("T")[1]
                      .split(".")[0]
                  }: ${payload.content}`;

                  //scroll
                  output.scrollTop = output.scrollHeight - output.clientHeight;
                }
                break;
              case "cons":
                {
                  $("#cons").innerText = payload.content
                }
                break;
            }
          },
          false
        );
      };
      join();

      const rejoiner = setInterval(() => {
        const rejoin = () => join(true, true);
        evtSource.readyState === EventSource.CLOSED
          ? [console.warn("No connection, rejoining..."), rejoin()]
          : console.debug(
              `Connection ${
                evtSource.readyState === 0 ? "waiting..." : "ok :)"
              }`
            );
      }, 9999);
    </script>
  </body>
</html>
